<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoFamily</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
<div id="app"></div>
<div id="modal"></div>

<script>
// Initialize Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA8xpPsK_E2hXgU5D5qw612SFA5vIVOTGU",
  authDomain: "ecofamily-ffa0a.firebaseapp.com",
  databaseURL: "https://ecofamily-ffa0a-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "ecofamily-ffa0a",
  storageBucket: "ecofamily-ffa0a.firebasestorage.app",
  messagingSenderId: "325072897213",
  appId: "1:325072897213:web:b2c6fa856b129e267963d4"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// App object
const app = {
  familyCode: null,
  currentUser: null,
  data: {
    family: [
      {id: 1, name: 'Jon', color: 'blue'},
      {id: 2, name: 'Johanna', color: 'purple'},
      {id: 3, name: 'Linn√©a', color: 'pink'},
      {id: 4, name: 'Rafael', color: 'green'},
      {id: 5, name: 'Alicia', color: 'orange'}
    ],
    meals: [],
    activities: [],
    future: [],
    wishes: [],
    shopping: {food: [], basics: [], big: []}
  },
  view: 'week',
  weekOffset: 0,

  async init() {
    const fc = localStorage.getItem('familyCode');
    const cu = localStorage.getItem('currentUser');
    
    if (fc && cu) {
      this.familyCode = fc;
      this.currentUser = JSON.parse(cu);
      await this.loadData();
      this.setupListeners();
      this.render();
    } else {
      this.showLogin();
    }
  },

  showLogin() {
    document.getElementById('app').innerHTML = `
      <div class="max-w-md mx-auto mt-20 p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8">
          <h1 class="text-3xl font-bold text-center mb-2">üè° EcoFamily</h1>
          <p class="text-center text-gray-600 mb-8">Familjeplaneraren</p>
          <div id="loginContent">
            <div class="space-y-4">
              <button onclick="app.showSetup()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl">
                üÜï Skapa ny familj
              </button>
              <button onclick="app.showJoin()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl">
                üë®‚Äçüë©‚Äçüëß‚Äçüë¶ G√• med i familj
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  },

  showSetup() {
    const familyOptions = this.data.family.map(m => 
      `<option value="${m.id}">${m.name}</option>`
    ).join('');

    document.getElementById('loginContent').innerHTML = `
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold mb-2">Skapa familje-kod:</label>
          <input type="text" id="familyCodeInput" placeholder="t.ex. ANDERSSON2026" 
            class="w-full p-3 border-2 rounded-xl uppercase" value="ANDERSSON2026">
          <p class="text-xs text-gray-600 mt-1">Dela med familjen</p>
        </div>
        <div>
          <label class="block text-sm font-bold mb-2">Ditt namn:</label>
          <select id="memberSelect" class="w-full p-3 border-2 rounded-xl">
            ${familyOptions}
          </select>
        </div>
        <button onclick="app.createFamily()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl">
          Skapa ‚Üí
        </button>
        <button onclick="app.showLogin()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-3 rounded-xl">
          ‚Üê Tillbaka
        </button>
      </div>
    `;
  },

  showJoin() {
    const familyOptions = this.data.family.map(m => 
      `<option value="${m.id}">${m.name}</option>`
    ).join('');

    document.getElementById('loginContent').innerHTML = `
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-bold mb-2">Familje-kod:</label>
          <input type="text" id="joinFamilyCode" placeholder="ANDERSSON2026" 
            class="w-full p-3 border-2 rounded-xl uppercase">
        </div>
        <div>
          <label class="block text-sm font-bold mb-2">Ditt namn:</label>
          <select id="joinMemberSelect" class="w-full p-3 border-2 rounded-xl">
            ${familyOptions}
          </select>
        </div>
        <button onclick="app.joinFamily()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded-xl">
          G√• med ‚Üí
        </button>
        <button onclick="app.showLogin()" class="w-full bg-gray-200 hover:bg-gray-300 font-bold py-3 rounded-xl">
          ‚Üê Tillbaka
        </button>
      </div>
    `;
  },

  async createFamily() {
    const fc = document.getElementById('familyCodeInput').value.trim().toUpperCase();
    const memberId = parseInt(document.getElementById('memberSelect').value);
    
    if (!fc || fc.length < 6) {
      alert('Koden m√•ste vara minst 6 tecken');
      return;
    }
    
    try {
      const snapshot = await db.ref(`families/${fc}`).once('value');
      if (snapshot.exists()) {
        alert('Denna kod anv√§nds redan');
        return;
      }
      
      this.familyCode = fc;
      this.currentUser = this.data.family.find(m => m.id === memberId);
      
      localStorage.setItem('familyCode', fc);
      localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
      
      await db.ref(`families/${fc}`).set({
        created: new Date().toISOString(),
        sharedData: this.data
      });
      
      await this.loadData();
      this.setupListeners();
      this.render();
    } catch (error) {
      console.error('Error creating family:', error);
      alert('Kunde inte skapa familj. Kontrollera internetanslutning.');
    }
  },

  async joinFamily() {
    const fc = document.getElementById('joinFamilyCode').value.trim().toUpperCase();
    const memberId = parseInt(document.getElementById('joinMemberSelect').value);
    
    if (!fc) {
      alert('Ange familje-kod');
      return;
    }
    
    try {
      const snapshot = await db.ref(`families/${fc}`).once('value');
      if (!snapshot.exists()) {
        alert('Kunde inte hitta familj med denna kod');
        return;
      }
      
      this.familyCode = fc;
      this.currentUser = this.data.family.find(m => m.id === memberId);
      
      localStorage.setItem('familyCode', fc);
      localStorage.setItem('currentUser', JSON.stringify(this.currentUser));
      
      await this.loadData();
      this.setupListeners();
      this.render();
    } catch (error) {
      console.error('Error joining family:', error);
      alert('Kunde inte g√• med i familj. Kontrollera internetanslutning.');
    }
  },

  logout() {
    if (confirm('Logga ut?')) {
      localStorage.clear();
      location.reload();
    }
  },

  async loadData() {
    if (!this.familyCode) return;
    
    try {
      const snapshot = await db.ref(`families/${this.familyCode}/sharedData`).once('value');
      if (snapshot.exists()) {
        this.data = {...this.data, ...snapshot.val()};
      }
    } catch (error) {
      console.error('Error loading data:', error);
    }
  },

  setupListeners() {
    if (!this.familyCode) return;
    
    db.ref(`families/${this.familyCode}/sharedData`).on('value', (snapshot) => {
      if (snapshot.exists()) {
        this.data = {...this.data, ...snapshot.val()};
        this.render();
      }
    });
  },

  async saveData() {
    if (!this.familyCode) return;
    
    try {
      await db.ref(`families/${this.familyCode}/sharedData`).set(this.data);
    } catch (error) {
      console.error('Error saving data:', error);
    }
  },

  getWeek(offset) {
    const dates = [];
    const today = new Date();
    const day = today.getDay();
    const diff = today.getDate() - day + (day === 0 ? -6 : 1);
    const monday = new Date(today.setDate(diff + offset * 7));
    
    for (let i = 0; i < 7; i++) {
      const date = new Date(monday);
      date.setDate(monday.getDate() + i);
      dates.push(date);
    }
    return dates;
  },

  formatDate(date) {
    return date.toISOString().split('T')[0];
  },

  dayName(date) {
    return ['S√∂n', 'M√•n', 'Tis', 'Ons', 'Tor', 'Fre', 'L√∂r'][date.getDay()];
  },

  switchView(view) {
    this.view = view;
    this.render();
  },

  async addActivity() {
    const title = prompt('Aktivitet:');
    if (!title) return;
    const person = parseInt(prompt('Vem? 1=Jon 2=Johanna 3=Linn√©a 4=Rafael 5=Alicia'));
    const date = prompt('Datum (YYYY-MM-DD):');
    const time = prompt('Tid:', '17:00');
    
    this.data.activities.push({
      id: Date.now().toString(),
      title: title,
      person: person,
      date: date,
      time: time,
      addedBy: this.currentUser.name
    });
    
    await this.saveData();
    this.render();
  },

  async deleteItem(type, id) {
    if (confirm('Ta bort?')) {
      this.data[type] = this.data[type].filter(x => x.id !== id);
      await this.saveData();
      this.render();
    }
  },

  render() {
    const week = this.getWeek(this.weekOffset);
    
    let html = `
      <div class="max-w-6xl mx-auto p-4">
        <div class="bg-white rounded-xl shadow-lg p-4 mb-4">
          <div class="flex justify-between items-center mb-3">
            <div>
              <h1 class="text-xl font-bold">EcoFamily</h1>
              <p class="text-sm text-gray-600">${week[0].getDate()}/${week[0].getMonth()+1} - ${week[6].getDate()}/${week[6].getMonth()+1}</p>
            </div>
            <div class="flex gap-2">
              <button onclick="app.weekOffset--; app.render()" class="px-3 py-2 bg-gray-200 rounded text-sm">‚Üê</button>
              <button onclick="app.weekOffset=0; app.render()" class="px-3 py-2 bg-blue-600 text-white rounded text-sm">Idag</button>
              <button onclick="app.weekOffset++; app.render()" class="px-3 py-2 bg-gray-200 rounded text-sm">‚Üí</button>
            </div>
          </div>
          
          <div class="flex items-center justify-between mb-3">
            <div class="flex gap-2">
              ${this.data.family.map(p => `<span class="px-2 py-1 bg-${p.color}-100 text-${p.color}-700 rounded-full text-xs">${p.name}</span>`).join('')}
            </div>
            <button onclick="app.logout()" class="px-3 py-1 bg-gray-200 rounded text-xs">Logga ut</button>
          </div>
          
          <div class="p-2 bg-${this.currentUser.color}-50 rounded mb-3">
            <div class="text-sm font-bold">${this.currentUser.name}</div>
            <div class="text-xs text-gray-600">Kod: ${this.familyCode}</div>
          </div>
        </div>

        <div class="space-y-3">
    `;
    
    for (const day of week) {
      const dateStr = this.formatDate(day);
      const activities = this.data.activities.filter(a => a.date === dateStr);
      const meals = this.data.meals.filter(m => m.date === dateStr);
      
      html += `
        <div class="bg-white rounded-xl shadow-lg p-4">
          <div class="flex justify-between mb-3">
            <h3 class="font-bold">${this.dayName(day)} ${day.getDate()}/${day.getMonth()+1}</h3>
            <button onclick="app.addActivity()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">+</button>
          </div>
      `;
      
      for (const meal of meals) {
        html += `
          <div class="bg-orange-50 border border-orange-200 rounded p-2 mb-2 flex justify-between">
            <div>
              <div class="font-bold text-sm">${meal.dish}</div>
              <div class="text-xs text-gray-600">${meal.portions} portioner</div>
            </div>
            <button onclick="app.deleteItem('meals', '${meal.id}')" class="text-red-600 text-sm">‚úï</button>
          </div>
        `;
      }
      
      for (const activity of activities) {
        const person = this.data.family.find(p => p.id === activity.person);
        if (person) {
          html += `
            <div class="bg-${person.color}-50 border border-${person.color}-200 rounded p-2 mb-2 flex justify-between">
              <div>
                <div class="font-bold text-sm">${activity.title}</div>
                <div class="text-xs text-gray-600">${activity.time} ‚Ä¢ ${person.name}</div>
              </div>
              <button onclick="app.deleteItem('activities', '${activity.id}')" class="text-red-600 text-sm">‚úï</button>
            </div>
          `;
        }
      }
      
      if (activities.length === 0 && meals.length === 0) {
        html += '<p class="text-gray-400 text-sm text-center py-4">Inget planerat</p>';
      }
      
      html += '</div>';
    }
    
    html += '</div></div>';
    
    document.getElementById('app').innerHTML = html;
  }
};

// Initialize app
app.init();
</script>
</body>
</html>
